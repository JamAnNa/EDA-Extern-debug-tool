<!doctype html>
<html lang="zh">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>JavaScript ç¼–è¾‘å™¨</title>
		<style>
			body {
				font-family: 'Courier New', monospace;
				margin: 0;
				padding: 0;
				background-color: #1e1e1e;
				color: #ffffff;
				min-height: 100vh;
				display: flex;
				flex-direction: column;
				transition: background-color 0.3s, color 0.3s;
			}

			.light-mode {
				background-color: #f0f0f0;
				color: #000;
			}

			.container {
				display: flex;
				flex-grow: 1;
				height: 100vh;
				overflow: hidden;
			}

			.sidebar {
				width: auto;
				min-width: 150px;
				background-color: #2d2d2d;
				box-shadow: 4px 0 6px rgba(0, 0, 0, 0.2);
				padding: 20px;
				display: flex;
				flex-direction: column;
				align-items: center;
				border-right: 1px solid #333;
				transition: background-color 0.3s, color 0.3s;
			}

			.light-mode .sidebar {
				background-color: #e0e0e0;
				box-shadow: 4px 0 6px rgba(0, 0, 0, 0.1);
				color: #000;
			}

			.sidebar h2 {
				font-size: 1.2em;
				margin-bottom: 15px;
				margin-top: -5px;
				color: #00cc99;
				transition: color 0.3s;
			}

			.light-mode .sidebar h2 {
				color: #000;
			}

			.sidebar button {
				width: 100%;
				background-color: #333;
				color: #fff;
				border: none;
				padding: 10px 15px;
				margin-bottom: 10px;
				border-radius: 5px;
				cursor: pointer;
				transition: background-color 0.3s, color 0.3s;
			}

			.light-mode .sidebar button {
				background-color: #ddd;
				color: #000;
			}

			.sidebar button:hover {
				background-color: #444;
			}

			.light-mode .sidebar button:hover {
				background-color: #ccc;
			}

			.editor-container {
				flex-grow: 1;
				display: flex;
				flex-direction: column;
				overflow: hidden;
			}

			h1 {
				margin: 0;
				padding: 15px 20px;
				background-color: #0d0d0d;
				color: #00cc99;
				font-size: 1.5em;
				text-align: center;
				border-bottom: 1px solid #333;
				transition: background-color 0.3s, color 0.3s;
			}

			.light-mode h1 {
				background-color: #ffffff;
				color: #000000;
				border-bottom: 1px solid #ccc;
			}

			#codeInput {
				flex-grow: 1;
				padding: 15px;
				font-family: 'Courier New', monospace;
				font-size: 14px;
				background-color: #2d2d2d;
				color: #ffffff;
				border: none;
				resize: none;
				outline: none;
				caret-color: white;
				white-space: pre;
				overflow-wrap: normal;
				overflow-x: auto;
				overflow-y: auto;

				/* WebKit æ»šåŠ¨æ¡æ ·å¼ */
				::-webkit-scrollbar {
					width: 8px;
					height: 8px;
				}

				::-webkit-scrollbar-track {
					background: transparent;
				}

				::-webkit-scrollbar-thumb {
					background-color: rgba(255, 255, 255, 0.2);
					border-radius: 4px;
				}

				::-webkit-scrollbar-thumb:hover {
					background-color: rgba(255, 255, 255, 0.3);
				}

				/* Firefox æ»šåŠ¨æ¡ */
				scrollbar-width: thin;
				scrollbar-color: rgba(255, 255, 255, 0.2) transparent;

				transition: background-color 0.3s,
				color 0.3s;
			}

			/* --- LIGHT MODE: ä¿®å¤ä»£ç ç¼–è¾‘å™¨é¢œè‰²ä¸æ»šåŠ¨æ¡ --- */
			.light-mode #codeInput {
				background-color: #fafafa;
				color: #000000;
				caret-color: black;
			}

			.light-mode #codeInput::-webkit-scrollbar {
				width: 8px;
				height: 8px;
			}

			.light-mode #codeInput::-webkit-scrollbar-track {
				background: transparent;
			}

			.light-mode #codeInput::-webkit-scrollbar-thumb {
				background-color: rgba(0, 0, 0, 0.2);
			}

			.light-mode #codeInput::-webkit-scrollbar-thumb:hover {
				background-color: rgba(0, 0, 0, 0.3);
			}

			.light-mode #codeInput {
				scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
			}

			/* --- è‡ªå®šä¹‰å¼¹çª—æ ·å¼ --- */
			.modal {
				display: none;
				position: fixed;
				z-index: 1000;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.7);
			}

			.modal-content {
				position: fixed;
				/* å›ºå®šåœ¨è§†å£ä¸­ */
				top: 50%;
				/* å‚ç›´æ–¹å‘å±…ä¸­ */
				left: 50%;
				/* æ°´å¹³æ–¹å‘å±…ä¸­ */
				transform: translate(-50%, -50%);
				/* è°ƒæ•´åç§» */
				background-color: #2d2d2d;
				padding: 20px;
				border-radius: 10px;
				width: 90%;
				/* æœ€å¤§å®½åº¦ä¸ºå±å¹•çš„ 90% */
				max-width: 400px;
				/* è®¾ç½®æœ€å¤§å®½åº¦ */
				max-height: 80vh;
				/* æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦çš„ 80% */
				overflow-y: auto;
				/* å…è®¸å†…å®¹æ»šåŠ¨ */
				box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
				transition: background-color 0.3s, color 0.3s;
			}

			.light-mode .modal-content {
				background-color: #ffffff;
				color: #000;
			}


			/* æœç´¢æ¡†æ ·å¼ */
			#searchInput {
				position: sticky;
				/* å›ºå®šåœ¨é¡¶éƒ¨ */
				top: 0;
				/* è·ç¦»é¡¶éƒ¨ 0 */
				z-index: 1;
				/* ç¡®ä¿è¦†ç›–å…¶ä»–å†…å®¹ */
				width: 100%;
				padding: 10px;
				margin-bottom: 10px;
				border: none;
				border-radius: 5px;
				background-color: #333;
				color: #fff;
				transition: background-color 0.3s, color 0.3s;
				box-sizing: border-box;
			}

			/* éšè—æœç´¢æ¡† */
			#searchInput.hidden {
				display: none;
			}


			.light-mode #searchInput {
				background-color: #fafafa;
				color: #000;
			}

			/* å¼¹çª—å†…å®¹åŒºåŸŸæ ·å¼ */
			.modal-body {
				max-height: calc(80vh - 150px);
				/* å‡å»å¤´éƒ¨ã€æœç´¢æ¡†å’Œåº•éƒ¨æŒ‰é’®çš„é«˜åº¦ */
				overflow-y: auto;
				scrollbar-width: none;
				/* éšè—æ»šåŠ¨æ¡ï¼ˆé€‚ç”¨äº Firefoxï¼‰ */
			}

			.modal-body::-webkit-scrollbar {
				display: none;
				/* éšè—æ»šåŠ¨æ¡ï¼ˆé€‚ç”¨äº WebKit æµè§ˆå™¨ï¼Œå¦‚ Chrome å’Œ Edgeï¼‰ */
			}



			.modal-header {
				font-size: 1.2em;
				margin-bottom: 15px;
				color: #00cc99;
				transition: color 0.3s;
			}

			.light-mode .modal-header {
				color: #000;
			}

			.modal-body {
				max-height: 200px;
				overflow-y: auto;
			}

			.modal-body div {
				padding: 10px;
				cursor: pointer;
				border-radius: 5px;
				transition: background-color 0.3s;
				display: flex;
				justify-content: space-between;
				align-items: center;
				overflow-y: auto;
				/* å…è®¸å‚ç›´æ»šåŠ¨ */
				scrollbar-width: none;
				/* éšè—æ»šåŠ¨æ¡ï¼ˆé€‚ç”¨äº Firefoxï¼‰ */
			}

			.modal-body::-webkit-scrollbar {
				display: none;
				/* éšè—æ»šåŠ¨æ¡ï¼ˆé€‚ç”¨äº WebKit æµè§ˆå™¨ï¼Œå¦‚ Chrome å’Œ Edgeï¼‰ */
			}

			.modal-body div:hover {
				background-color: #333;
			}

			.light-mode .modal-body div:hover {
				background-color: #ddd;
			}

			.startup-checkbox {
				margin-left: 10px;
				width: 16px;
				height: 16px;
				cursor: pointer;
			}

			.modal-input {
				width: 100%;
				max-width: calc(100% - 20px);
				padding: 10px;
				margin: 0 auto 10px auto;
				border: none;
				border-radius: 5px;
				background-color: #333;
				color: #fff;
				transition: background-color 0.3s, color 0.3s;
				box-sizing: border-box;
			}

			.light-mode .modal-input {
				background-color: #fafafa;
				color: #000;
			}

			.modal-button {
				background-color: #00cc99;
				color: #fff;
				border: none;
				padding: 10px 15px;
				border-radius: 5px;
				cursor: pointer;
				transition: background-color 0.3s;
			}

			.modal-button:hover {
				background-color: #00b386;
			}

			.modal-cancel {
				background-color: #ff6b6b;
				margin-left: 10px;
			}

			.modal-cancel:hover {
				background-color: #ff4d4d;
			}

			/* --- æç¤ºæ¶ˆæ¯æ ·å¼ --- */
			.toast {
				display: none;
				position: fixed;
				bottom: 20px;
				right: 20px;
				background-color: #2d2d2d;
				color: #fff;
				padding: 15px 20px;
				border-radius: 5px;
				box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
				z-index: 1001;
				transition: background-color 0.3s, color 0.3s;
			}

			.light-mode .toast {
				background-color: #ffffff;
				color: #000;
			}
		</style>

	</head>
	<body>
		<div class="container">
			<div class="sidebar neumorphism">
				<h2>æ“ä½œ</h2>
				<button id="toggleTheme">åˆ‡æ¢ä¸»é¢˜</button>
				<button id="saveCode">ä¿å­˜ä»£ç </button>
				<button id="loadCode">åŠ è½½ä»£ç </button>
				<button id="loadCodeForServer">ä»äº‘ç«¯åŠ è½½</button>
				<button id="deleteCode">åˆ é™¤ä»£ç </button>
				<button id="setStartup">è®¾ç½®å¯åŠ¨é¡¹</button>
				<button id="importCode">å¯¼å…¥ä»£ç </button>
				<button id="exportCode">å¯¼å‡ºå…¨éƒ¨ä»£ç </button>
			</div>
			<div class="editor-container">
				<h1>JavaScript ç¼–è¾‘å™¨</h1>
				<textarea id="codeInput" autofocus></textarea>
			</div>
		</div>

		<!-- è‡ªå®šä¹‰å¼¹çª— -->
		<div id="modal" class="modal">
			<div class="modal-content">
				<div class="modal-header" id="modalHeader">é€‰æ‹©ä»£ç </div>
				<!-- æ–°å¢æœç´¢æ¡† -->
				<input type="text" id="searchInput" class="modal-input" placeholder="æœç´¢..." />
				<div class="modal-body" id="modalBody"></div>
				<input type="text" id="modalInput" class="modal-input" placeholder="è¾“å…¥ä»£ç åç§°" style="display: none;" />
				<div style="display: flex; justify-content: space-between;">
					<button id="modalConfirm" class="modal-button">ç¡®è®¤</button>
					<button id="modalCancel" class="modal-button modal-cancel">å–æ¶ˆ</button>
				</div>
			</div>
		</div>


		<!-- æç¤ºæ¶ˆæ¯ -->
		<div id="toast" class="toast"></div>

		<!-- ç¬¬ä¸‰æ–¹åº“ -->
		<script src="https://cdn.jsdelivr.net/npm/prettier@2.7.1/standalone.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/prettier@2.7.1/parser-babel.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

		<script>
			let isLightMode = false;
			let currentEditingName = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„ä»£ç åç§°
			let db;

			// åˆå§‹åŒ– IndexedDB æ•°æ®åº“
			function initDB() {
				return new Promise((resolve, reject) => {
					const request = indexedDB.open('JavaScriptEditorDB', 1);

					request.onerror = (event) => {
						console.error('IndexedDB åˆå§‹åŒ–å¤±è´¥:', event);
						reject('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥');
					};

					request.onsuccess = (event) => {
						db = event.target.result;
						resolve(db);
					};

					request.onupgradeneeded = (event) => {
						db = event.target.result;
						if (!db.objectStoreNames.contains('CodeStore')) {
							db.createObjectStore('CodeStore', { keyPath: 'name' });
						}
					};
				});
			}

			// ä¿å­˜ä»£ç åˆ° IndexedDB
			async function saveCodeToDB(name, code) {
				try {
					const transaction = db.transaction(['CodeStore'], 'readwrite');
					const store = transaction.objectStore('CodeStore');
					await new Promise((resolve, reject) => {
						const request = store.put({ name, code });
						request.onsuccess = resolve;
						request.onerror = reject;
					});
					showToast(`âœ… ä»£ç å·²ä¿å­˜ä¸ºï¼š${name}`);
				} catch (error) {
					console.error('ä¿å­˜ä»£ç å¤±è´¥:', error);
					showToast('âŒ ä¿å­˜ä»£ç å¤±è´¥');
				}
			}

			// ä» IndexedDB åŠ è½½ä»£ç 
			async function loadCodeFromDB(name) {
				try {
					const transaction = db.transaction(['CodeStore'], 'readonly');
					const store = transaction.objectStore('CodeStore');
					const result = await new Promise((resolve, reject) => {
						const request = store.get(name);
						request.onsuccess = () => resolve(request.result?.code || null);
						request.onerror = reject;
					});
					return result;
				} catch (error) {
					console.error('åŠ è½½ä»£ç å¤±è´¥:', error);
					showToast('âŒ åŠ è½½ä»£ç å¤±è´¥');
					return null;
				}
			}

			// ä» IndexedDB åˆ é™¤ä»£ç 
			// ä» IndexedDB åˆ é™¤ä»£ç ï¼Œå¹¶æ¸…ç†å¯åŠ¨é¡¹ä¸­çš„å¼•ç”¨
			async function deleteCodeFromDB(name) {
				try {
					// 1. å…ˆåˆ é™¤ä¸»ä»£ç 
					const transaction = db.transaction(['CodeStore'], 'readwrite');
					const store = transaction.objectStore('CodeStore');

					await new Promise((resolve, reject) => {
						const request = store.delete(name);
						request.onsuccess = resolve;
						request.onerror = reject;
					});

					showToast(`âœ… ä»£ç  "${name}" å·²åˆ é™¤ï¼`);

					// 2. è·å–å½“å‰å¯åŠ¨é¡¹åˆ—è¡¨å¹¶è¿‡æ»¤æ‰è¢«åˆ é™¤çš„é¡¹
					const startupList = await getStartupCodesFromDB();
					const updatedStartupList = startupList.filter(item => item !== name);

					if (startupList.length !== updatedStartupList.length) {
						// å¦‚æœæœ‰å˜åŒ–ï¼Œè¯´æ˜è¿™ä¸ªè„šæœ¬æ˜¯å¯åŠ¨é¡¹ä¹‹ä¸€ï¼Œéœ€è¦æ›´æ–°
						await setStartupCodesToDB(updatedStartupList);
						console.log(`ğŸ“Œ å·²ä»å¯åŠ¨é¡¹ä¸­ç§»é™¤: ${name}`);
					}

					// 3. æ›´æ–°å½“å‰ç¼–è¾‘çŠ¶æ€
					if (currentEditingName === name) {
						currentEditingName = null;
					}

				} catch (error) {
					console.error('åˆ é™¤ä»£ç å¤±è´¥:', error);
					showToast('âŒ åˆ é™¤ä»£ç å¤±è´¥');
				}
			}

			// è·å–æ‰€æœ‰ä»£ç åç§°
			async function getAllCodeNamesFromDB() {
				try {
					const transaction = db.transaction(['CodeStore'], 'readonly');
					const store = transaction.objectStore('CodeStore');
					const result = await new Promise((resolve, reject) => {
						const request = store.getAllKeys();
						request.onsuccess = () => resolve(request.result);
						request.onerror = reject;
					});

					// è¿‡æ»¤æ‰ '__startup__' é”®
					return result.filter(name => name !== '__startup__');
				} catch (error) {
					console.error('è·å–ä»£ç åç§°å¤±è´¥:', error);
					showToast('âŒ è·å–ä»£ç åç§°å¤±è´¥');
					return [];
				}
			}


			// è®¾ç½®å¯åŠ¨é¡¹
			async function setStartupCodesToDB(startupCodes) {
				try {
					const transaction = db.transaction(['CodeStore'], 'readwrite');
					const store = transaction.objectStore('CodeStore');
					await new Promise((resolve, reject) => {
						const request = store.put({ name: '__startup__', code: JSON.stringify(startupCodes) });
						request.onsuccess = resolve;
						request.onerror = reject;
					});
					showToast(`${startupCodes.length} ä¸ªä»£ç å·²è®¾ä¸ºå¯åŠ¨é¡¹ï¼`);
				} catch (error) {
					console.error('è®¾ç½®å¯åŠ¨é¡¹å¤±è´¥:', error);
					showToast('âŒ è®¾ç½®å¯åŠ¨é¡¹å¤±è´¥');
				}
			}

			// è·å–å¯åŠ¨é¡¹
			async function getStartupCodesFromDB() {
				try {
					const transaction = db.transaction(['CodeStore'], 'readonly');
					const store = transaction.objectStore('CodeStore');
					const result = await new Promise((resolve, reject) => {
						const request = store.get('__startup__');
						request.onsuccess = () => resolve(JSON.parse(request.result?.code || '[]'));
						request.onerror = reject;
					});
					return result;
				} catch (error) {
					console.error('è·å–å¯åŠ¨é¡¹å¤±è´¥:', error);
					showToast('âŒ è·å–å¯åŠ¨é¡¹å¤±è´¥');
					return [];
				}
			}


			// Tab é”®ç¼©è¿› + å¿«æ·é”®æ”¯æŒ
			document.getElementById('codeInput').addEventListener('keydown', function(e) {
				// Tab ç¼©è¿›
				if (e.key === 'Tab') {
					e.preventDefault();
					const start = this.selectionStart;
					const end = this.selectionEnd;
					this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
					this.selectionStart = this.selectionEnd = start + 4;
				}

				// Ctrl+Enter æˆ– Cmd+Enter è¿è¡Œä»£ç 
				if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
					e.preventDefault();
					runCode();
				}

				// Ctrl+K æˆ– Cmd+K æ ¼å¼åŒ–ä»£ç 
				if (e.key === 'k' && (e.ctrlKey || e.metaKey)) {
					e.preventDefault();
					formatCode();
				}

				// Ctrl+S æˆ– Cmd+S å¼¹å‡ºä¿å­˜å¼¹çª—
				if (e.key === 's' && (e.ctrlKey || e.metaKey)) {
					e.preventDefault();
					showSaveModal();
				}
			});

			// åˆ‡æ¢ä¸»é¢˜ + è®°å¿†åŠŸèƒ½
			document.getElementById('toggleTheme').addEventListener('click', () => {
				isLightMode = !isLightMode;
				document.body.classList.toggle('light-mode', isLightMode);
				// ä¿å­˜åˆ° localStorage
				localStorage.setItem('themeMode', isLightMode ? 'light' : 'dark');
			});

			// æ ¼å¼åŒ–ä»£ç 
			function formatCode() {
				fixEdaApiCasing();
				const code = document.getElementById('codeInput').value;
				try {
					// ä½¿ç”¨ prettier æ ¼å¼åŒ–ä»£ç ï¼Œå¹¶ç¦ç”¨è‡ªåŠ¨æ¢è¡Œ
					const formatted = prettier.format(code, {
						parser: 'babel',
						plugins: [prettierPlugins.babel],
						printWidth: Infinity, // ç¦ç”¨è‡ªåŠ¨æ¢è¡Œ
					});
					document.getElementById('codeInput').value = formatted;
				} catch (error) {
					console.error('æ ¼å¼åŒ–å¤±è´¥ï¼š' + error.message);
					showToast('âŒ æ ¼å¼åŒ–ä»£ç å¤±è´¥');
				}
			}

			// è¿è¡Œä»£ç 
			function runCode() {
				const code = document.getElementById('codeInput').value;
				if (!code.trim()) return;
				try {
					eval(code);
				} catch (error) {
					console.error('âŒ é”™è¯¯ï¼š' + error.message);
				}
			}

			// æ˜¾ç¤ºå¼¹çª—ï¼ˆé€šç”¨ï¼‰
			function showModal(mode, headerText, bodyContent, onConfirm, defaultValue = '') {
				const selectedItems = new Set();
				const modal = document.getElementById('modal');
				const modalHeader = document.getElementById('modalHeader');
				const modalBody = document.getElementById('modalBody');
				const modalInput = document.getElementById('modalInput');
				const modalConfirm = document.getElementById('modalConfirm');
				const modalCancel = document.getElementById('modalCancel');
				const searchInput = document.getElementById('searchInput');

				modalHeader.textContent = headerText;
				modalBody.innerHTML = '';
				modalInput.style.display = mode === 'save' ? 'block' : 'none';
				modalInput.value = defaultValue || '';

				if (mode === 'save') {
					searchInput.classList.add('hidden');
				} else {
					searchInput.classList.remove('hidden');
					searchInput.value = '';
				}

				if (mode === 'load' || mode === 'delete') {
					bodyContent.forEach((item) => {
						const div = document.createElement('div');
						div.textContent = item;
						div.addEventListener('click', () => {
							Array.from(modalBody.children).forEach((child) => child.style.backgroundColor = '');
							div.style.backgroundColor = isLightMode ? '#ddd' : '#333';
							selectedItems.clear();
							selectedItems.add(item);
						});
						modalBody.appendChild(div);
					});
				} else if (mode === 'startup') {
					// ä» IndexedDB è·å–å¯åŠ¨é¡¹æ•°æ®
					getStartupCodesFromDB().then(currentStartupList => {
						currentStartupList.forEach(item => selectedItems.add(item));

						bodyContent.forEach((item) => {
							const div = document.createElement('div');
							const nameSpan = document.createElement('span');
							nameSpan.textContent = item;

							const checkbox = document.createElement('input');
							checkbox.type = 'checkbox';
							checkbox.className = 'startup-checkbox';
							checkbox.checked = selectedItems.has(item);

							checkbox.addEventListener('change', () => {
								if (checkbox.checked) {
									selectedItems.add(item);
								} else {
									selectedItems.delete(item);
								}
							});

							div.appendChild(nameSpan);
							div.appendChild(checkbox);

							div.addEventListener('click', (e) => {
								if (e.target !== checkbox) {
									checkbox.checked = !checkbox.checked;
									if (checkbox.checked) {
										selectedItems.add(item);
									} else {
										selectedItems.delete(item);
									}
								}
							});

							modalBody.appendChild(div);
						});
					});
				}

				modalConfirm.onclick = () => {
					if (mode === 'save') {
						const name = modalInput.value.trim();
						if (!name) return showToast('è¯·è¾“å…¥ä»£ç åç§°ï¼');
						onConfirm(name);
					} else if (mode === 'startup') {
						onConfirm(Array.from(selectedItems));
					} else {
						const selectedItem = Array.from(selectedItems)[0] || '';
						if (!selectedItem) return showToast('è¯·é€‰æ‹©ä¸€é¡¹ï¼');
						onConfirm(selectedItem);
					}
					hideModal();
				};

				modalCancel.onclick = hideModal;
				modal.style.display = 'block';
			}


			// éšè—å¼¹çª—
			function hideModal() {
				document.getElementById('modal').style.display = 'none';
				document.getElementById('searchInput').value = '';
			}

			// æ˜¾ç¤ºä¿å­˜å¼¹çª—
			async function showSaveModal() {
				const savedCodes = await getAllCodeNamesFromDB();
				showModal('save', 'ä¿å­˜ä»£ç ', savedCodes, async (name) => {
					const code = document.getElementById('codeInput').value;
					if (!code.trim()) {
						return showToast('æ— æ³•ä¿å­˜ç©ºä»£ç ï¼');
					}
					await saveCodeToDB(name, code);
				}, currentEditingName);
			}

			// ç»‘å®šä¿å­˜æŒ‰é’®
			document.getElementById('saveCode').addEventListener('click', showSaveModal);

			// åŠ è½½ä»£ç 
			document.getElementById('loadCode').addEventListener('click', async () => {
				const savedCodes = await getAllCodeNamesFromDB();
				if (savedCodes.length === 0) {
					showToast('æ²¡æœ‰ä¿å­˜çš„ä»£ç ï¼');
					return;
				}
				showModal('load', 'åŠ è½½ä»£ç ', savedCodes, async (name) => {
					const code = await loadCodeFromDB(name);
					if (code) {
						document.getElementById('codeInput').value = code;
						currentEditingName = name;
						showToast('ä»£ç å·²åŠ è½½ï¼');
					}
				});
			});

			// åˆ é™¤ä»£ç 
			document.getElementById('deleteCode').addEventListener('click', async () => {
				const savedCodes = await getAllCodeNamesFromDB();
				if (savedCodes.length === 0) {
					showToast('æ²¡æœ‰ä¿å­˜çš„ä»£ç ï¼');
					return;
				}
				showModal('delete', 'åˆ é™¤ä»£ç ', savedCodes, async (name) => {
					await deleteCodeFromDB(name);
					if (currentEditingName === name) {
						currentEditingName = null;
					}
					showToast('ä»£ç å·²åˆ é™¤ï¼');
				});
			});

			// è®¾ç½®å¯åŠ¨é¡¹
			document.getElementById('setStartup').addEventListener('click', async () => {
				const savedCodes = await getAllCodeNamesFromDB();
				if (savedCodes.length === 0) {
					showToast('æ²¡æœ‰ä¿å­˜çš„ä»£ç ï¼');
					return;
				}
				showModal('startup', 'è®¾ç½®å¯åŠ¨é¡¹ï¼ˆå¯å¤šé€‰ï¼‰', savedCodes, async (selectedNames) => {
					await setStartupCodesToDB(selectedNames);
				});
			});

			document.getElementById('loadCodeForServer').addEventListener('click', async () => {
				//await eda.sys_Message.showToastMessage("è¿™ä¸ªåŠŸèƒ½è¿˜æ²¡åš",1);
				if (isLightMode) {
					await eda.sys_IFrame.openIFrame("/iframe/debug/tool/LoadCodeForServer-Light.html", 500, 600, "ServerCode");
				} else {
					await eda.sys_IFrame.openIFrame("/iframe/debug/tool/LoadCodeForServer-Night.html", 500, 600, "ServerCode");
				}
			})

			// å¯¼å…¥ä»£ç 
			document.getElementById('importCode').addEventListener('click', () => {
				const input = document.createElement('input');
				input.type = 'file';
				input.accept = '.js,.zip';
				input.multiple = false;

				input.onchange = async (e) => {
					const file = e.target.files[0];
					if (!file) return;

					try {
						if (file.name.endsWith('.js')) {
							const reader = new FileReader();
							reader.onload = async () => {
								const code = reader.result;
								let name = file.name.slice(0, -3);
								const savedCodes = await getAllCodeNamesFromDB();
								if (savedCodes.includes(name)) {
									if (!confirm(`æ–‡ä»¶ "${name}" å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) {
										name = prompt('è¯·è¾“å…¥æ–°åç§°ï¼š', name) || name + '_copy';
									}
								}
								await saveCodeToDB(name, code);
								showToast(`âœ… å·²å¯¼å…¥ï¼š${name}`);
							};
							reader.readAsText(file);
						} else if (file.name.endsWith('.zip')) {
							const zip = new JSZip();
							const content = await zip.loadAsync(file);
							let importedCount = 0;

							for (const [filename, zipEntry] of Object.entries(content.files)) {
								if (filename.endsWith('/') || !filename.endsWith('.js')) continue;
								let name = filename.slice(0, -3);
								const savedCodes = await getAllCodeNamesFromDB();
								if (savedCodes.includes(name)) {
									if (!confirm(`æ–‡ä»¶ "${name}" å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) continue;
								}
								const code = await zipEntry.async('string');
								await saveCodeToDB(name, code);
								importedCount++;
							}

							showToast(`âœ… å·²å¯¼å…¥ ${importedCount} ä¸ª .js æ–‡ä»¶ï¼`);
						} else {
							showToast('âŒ ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼');
						}
					} catch (err) {
						console.error(err);
						showToast('âŒ å¯¼å…¥å¤±è´¥ï¼š' + err.message);
					}
				};

				input.click();
			});

			// å¯¼å‡ºä»£ç 
			document.getElementById('exportCode').addEventListener('click', async () => {
				const savedCodes = {};
				const names = await getAllCodeNamesFromDB();
				if (names.length === 0) {
					showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„ä»£ç ï¼');
					return;
				}

				for (const name of names) {
					const code = await loadCodeFromDB(name);
					if (code) savedCodes[name] = code;
				}

				const zip = new JSZip();
				for (const [name, code] of Object.entries(savedCodes)) {
					zip.file(`${name}.js`, code);
				}

				try {
					const blob = await zip.generateAsync({ type: 'blob' });
					const link = document.createElement('a');
					link.href = URL.createObjectURL(blob);
					link.download = 'javascript-editor-backup.zip';
					link.click();
					showToast(`âœ… å·²å¯¼å‡º ${Object.keys(savedCodes).length} ä¸ªä»£ç æ–‡ä»¶ï¼`);
				} catch (err) {
					showToast('âŒ å¯¼å‡ºå¤±è´¥ï¼š' + err.message);
				}
			});

			// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
			function showToast(message) {
				const toast = document.getElementById('toast');
				toast.textContent = message;
				toast.style.display = 'block';
				setTimeout(() => {
					toast.style.display = 'none';
				}, 3000);
			}

			// ç›‘å¬ ESC å…³é—­å¼¹çª—
			document.addEventListener('keydown', function(e) {
				const modal = document.getElementById('modal');
				if (e.key === 'Escape' && modal.style.display === 'block') {
					hideModal();
				}
			});

			// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ•°æ®åº“å¹¶æ‰§è¡Œå¯åŠ¨é¡¹ + æ¢å¤ä¸»é¢˜
			window.onload = async () => {
				try {
					await initDB();

					const codeInput = document.getElementById('codeInput');
					codeInput.focus();

					// ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ–°å¢ï¼šæ¢å¤ç”¨æˆ·ä¸Šæ¬¡é€‰æ‹©çš„ä¸»é¢˜ ğŸ‘‡ğŸ‘‡ğŸ‘‡
					const savedTheme = localStorage.getItem('themeMode');
					if (savedTheme === 'light') {
						isLightMode = true;
						document.body.classList.add('light-mode');
					} else {
						isLightMode = false;
						document.body.classList.remove('light-mode');
					}

					const startupList = await getStartupCodesFromDB();
					if (startupList.length > 0) {
						for (const name of startupList) {
							const code = await loadCodeFromDB(name);
							if (code) {
								try {
									eval(code);
								} catch (error) {
									console.error(`âŒ å¯åŠ¨é¡¹æ‰§è¡Œå¤±è´¥ [${name}]ï¼š`, error.message);
								}
							}
						}
					}
				} catch (error) {
					console.error('é¡µé¢åŠ è½½å¤±è´¥:', error);
				}
			};

			function fixEdaApiCasing() {
				const editor = document.getElementById('codeInput');
				if (!editor) return;

				// ä¿å­˜å…‰æ ‡ä½ç½®
				const start = editor.selectionStart;
				const end = editor.selectionEnd;

				// åŒ¹é…ï¼šeda. åè·Ÿ å¤šä¸ªå¤§å†™å­—æ¯ + ä¸‹åˆ’çº¿ + å…¶ä½™å­—ç¬¦
				// åˆ†ç»„1: AAAï¼ˆè¦è½¬å°å†™ï¼‰
				// åˆ†ç»„2: _XXXï¼ˆä¿æŒåŸæ ·ï¼‰
				editor.value = editor.value.replace(
					/eda\.([A-Z]+)(_+[A-Za-z0-9_]*)/g,
					(match, prefix, rest) => {
						return `eda.${prefix.toLowerCase()}${rest}`;
					}
				);

				// æ¢å¤å…‰æ ‡ä½ç½®
				editor.setSelectionRange(start, end);
			}

			// æœç´¢åŠŸèƒ½
			document.getElementById('searchInput').addEventListener('input', function() {
				const searchTerm = this.value.trim().toLowerCase();
				const items = document.querySelectorAll('#modalBody > div');

				items.forEach(item => {
					const text = item.textContent.toLowerCase();
					if (text.includes(searchTerm)) {
						item.style.display = 'flex';
					} else {
						item.style.display = 'none';
					}
				});
			});
			//ä¸€é”®æŒ‚è½½å‡½æ•°åˆ°windows ç›®å‰æš‚ä¸ä½¿ç”¨
			for (let key in self) {
				if (typeof self[key] === 'function' && !window[key]) {
					window[key] = self[key];
					console.log(`âœ… è‡ªåŠ¨æš´éœ²å‡½æ•°: ${key}`);
				}
			}
		</script>
	</body>
</html>