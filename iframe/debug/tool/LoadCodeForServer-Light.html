<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<title>分布式节点管理</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<style>
			body {
				font-family: 'Courier New', monospace;
				background-color: #ffffff;
				color: #000000;
				margin: 0;
				padding: 0;
				height: 100vh;
				display: flex;
				flex-direction: column;
			}

			.header {
				text-align: center;
				padding: 20px;
				font-size: 1.8em;
				color: #009966;
				border-bottom: 1px solid #ccc;
				background: #f5f5f5;
			}

			.nodes-container {
				flex: 1;
				padding: 20px;
				overflow-y: auto;
				max-height: calc(100vh - 180px);
			}

			.node-item {
				padding: 12px;
				background: #f0f0f0;
				margin: 8px 0;
				border-radius: 5px;
				cursor: pointer;
				word-break: break-all;
				border: 1px solid #ddd;
			}

			.node-item:hover {
				background: #e0e0e0;
			}

			.empty {
				text-align: center;
				color: #666;
				padding: 40px;
			}

			.register-box {
				padding: 20px;
				display: flex;
				gap: 10px;
				justify-content: center;
				background: #ffffff;
				border-top: 1px solid #ccc;
				position: sticky;
				bottom: 40px;
				z-index: 10;
			}

			#domainInput {
				width: 300px;
				padding: 10px;
				background: #f0f0f0;
				color: #000;
				border: 1px solid #ccc;
				border-radius: 4px;
			}

			#registerBtn {
				padding: 10px 20px;
				background: #f0f0f0;
				/* 改为和节点列表一致的颜色 */
				color: #000000;
				border: 1px solid #ccc;
				border-radius: 4px;
				cursor: pointer;
			}

			#registerBtn:hover {
				background: #e0e0e0;
				/* 鼠标悬停效果 */
			}

			.how-to-node-link {
				text-align: center;
				padding: 10px 20px;
				background: #ffffff;
				border-top: 1px solid #ccc;
				position: sticky;
				bottom: 0;
				z-index: 10;
			}

			.how-to-node-link a {
				color: #009966;
				text-decoration: none;
				font-size: 0.9em;
			}

			.how-to-node-link a:hover {
				text-decoration: underline;
			}
		</style>
	</head>
	<body>
		<div class="header">云节点管理器</div>

		<div class="nodes-container" id="nodesList">
			<div>正在加载节点列表...</div>
		</div>

		<div class="register-box">
			<input type="text" id="domainInput" placeholder="输入域名（如 myserver.com）注册新节点...">
			<button id="registerBtn">注册</button>
		</div>

		<div class="how-to-node-link">
			<a href="#" onclick="handleHowToNode()">如何成为节点?</a>
		</div>

		<script>
			const FILE_LIST_TEMPLATE = `
            <div class="app-container">
                <div class="header-bar">云文件列表</div>

                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="输入文件名进行搜索..." autocomplete="off">
                </div>

                <div class="batch-actions-bar">
                    <div class="batch-left">
                        <input type="checkbox" id="selectAll" title="全选/取消全选">
                        <label for="selectAll" style="cursor: pointer;">全选</label>
                        <button class="btn" id="batchDownload">批量下载</button>
                        <button class="btn" id="batchImport">批量导入</button>
                    </div>
                    <div>已选中 <span id="selectedCount">0</span> 项</div>
                </div>

                <div class="main-content">
                    <div id="loading">正在加载文件列表...</div>
                    <div class="file-list" id="fileList"></div>
                </div>
            </div>

            <div id="confirmModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">⚠️ 文件已存在</div>
                    <div class="modal-body" id="confirmMessage">是否覆盖？</div>
                    <div class="modal-footer">
                        <button class="modal-btn cancel" id="confirmCancel">取消</button>
                        <button class="modal-btn confirm" id="confirmOK">覆盖</button>
                    </div>
                </div>
            </div>

            <div id="messageModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header" id="messageTitle">提示</div>
                    <div class="modal-body" id="messageContent"></div>
                    <div class="modal-footer">
                        <button class="modal-btn" id="messageClose">确定</button>
                    </div>
                </div>
            </div>
        `;

			// ========== 你原有的完整 CSS 样式（一字不改）==========
			const FILE_LIST_STYLES = `
            /* ========== 全局样式 ========== */
            body {
                font-family: 'Courier New', monospace;
                background-color: #ffffff;
                color: #000000;
                margin: 0;
                padding: 0;
            }

            .app-container {
                display: flex;
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }

            .header-bar {
                flex: 0 0 auto;
                background-color: #f5f5f5;
                color: #009966;
                padding: 15px 20px;
                text-align: center;
                font-size: 1.5em;
                border-bottom: 1px solid #ccc;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }

            .search-container {
                flex: 0 0 auto;
                background-color: #ffffff;
                padding: 15px 0;
                border-bottom: 1px solid #ccc;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .batch-actions-bar {
                flex: 0 0 auto;
                background-color: #ffffff;
                padding: 10px 20px;
                border-bottom: 1px solid #ccc;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .batch-left {
                display: flex;
                align-items: center;
                gap: 15px;
            }

            #searchInput {
                width: 100%;
                max-width: 500px;
                margin: 0 20px;
                padding: 10px 15px;
                background-color: #f0f0f0;
                color: #000;
                border: 1px solid #ccc;
                border-radius: 5px;
                font-family: 'Courier New', monospace;
                font-size: 14px;
                outline: none;
                transition: background-color 0.2s;
                box-sizing: border-box;
            }

            #searchInput:focus {
                background-color: #e0e0e0;
            }

            .main-content {
                flex: 1;
                overflow-y: auto;
                padding: 10px 0;
            }

            .main-content::-webkit-scrollbar {
                width: 6px;
            }

            .main-content::-webkit-scrollbar-track {
                background: #ffffff;
            }

            .main-content::-webkit-scrollbar-thumb {
                background: #ccc;
                border-radius: 3px;
            }

            .file-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .file-item {
                display: flex;
                align-items: center;
                padding: 12px 15px;
                border-bottom: 1px solid #ccc;
                background-color: #f0f0f0;
                transition: background-color 0.2s;
				border: 1px solid #ddd;
            }

            .file-item:hover {
                background-color: #e0e0e0;
            }

            .file-checkbox {
                width: 20px;
                height: 20px;
                margin-right: 15px;
                cursor: pointer;
            }

            .file-info {
                flex-grow: 1;
                display: flex;
                align-items: center;
            }

            .file-name {
                font-weight: bold;
                word-break: break-all;
            }

            .file-actions {
                display: flex;
                align-items: center;
            }

            .btn {
                padding: 8px 15px;
                background-color: #f0f0f0;
                color: #000;
                border: 1px solid #ccc;
                border-radius: 5px;
                cursor: pointer;
                font-family: 'Courier New', monospace;
                font-size: 14px;
                transition: background-color 0.2s;
            }

            .btn:hover {
                background-color: #e0e0e0;
            }

            .file-actions .btn {
                margin-left: 10px;
            }

            #loading, .empty-tip {
                text-align: center;
                padding: 40px;
                font-style: italic;
                color: #777;
            }

            .empty-tip {
                color: #999;
            }

            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                justify-content: center;
                align-items: center;
            }

            .modal-content {
                background-color: #f0f0f0;
                padding: 25px;
                border-radius: 10px;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                text-align: center;
				border: 1px solid #ccc;
            }

            .modal-header {
                font-size: 1.3em;
                margin-bottom: 20px;
                color: #009966;
                font-weight: bold;
            }

            .modal-body {
                margin-bottom: 25px;
                line-height: 1.6;
            }

            .modal-footer {
                display: flex;
                justify-content: space-between;
                gap: 10px;
            }

            .modal-btn {
                flex: 1;
                padding: 10px;
                background-color: #f0f0f0;
                color: #000;
                border: 1px solid #ccc;
                border-radius: 5px;
                cursor: pointer;
                font-family: 'Courier New', monospace;
                font-size: 14px;
                transition: background-color 0.2s;
            }

            .modal-btn:hover {
                background-color: #e0e0e0;
            }

            .modal-btn.confirm {
                background-color: #009966;
                color: #fff;
            }

            .modal-btn.confirm:hover {
                background-color: #007a52;
            }

            .modal-btn.cancel {
                background-color: #ff6b6b;
                color: #fff;
            }

            .modal-btn.cancel:hover {
                background-color: #ff4d4d;
            }
        `;

			// ========== 你原有的完整 JS 逻辑（仅做微调：传入 shareUrl）==========
			function initFileListView(shareUrl) {
				// 插入 HTML
				document.body.innerHTML = FILE_LIST_TEMPLATE;

				// 插入样式
				const styleEl = document.createElement('style');
				styleEl.textContent = FILE_LIST_STYLES;
				document.head.appendChild(styleEl);

				// ========== 以下是你原有的 JS 代码（几乎原封不动）==========
				let db;
				window.fileDataMap = {};
				const selectedFiles = new Set();

				function initDB() {
					return new Promise((resolve, reject) => {
						const request = indexedDB.open('JavaScriptEditorDB', 1);
						request.onerror = () => reject('数据库初始化失败');
						request.onsuccess = (e) => {
							db = e.target.result;
							resolve(db);
						};
						request.onupgradeneeded = (e) => {
							const store = e.target.result.createObjectStore('CodeStore', { keyPath: 'name' });
						};
					});
				}

				async function getAllCodeNamesFromDB() {
					try {
						const tx = db.transaction(['CodeStore'], 'readonly');
						const store = tx.objectStore('CodeStore');
						return await new Promise((resolve, reject) => {
							const req = store.getAllKeys();
							req.onsuccess = () => resolve(req.result.filter(n => n !== '__startup__'));
							req.onerror = () => resolve([]);
						});
					} catch (e) { return []; }
				}

				async function saveCodeToDB(name, code) {
					try {
						const tx = db.transaction(['CodeStore'], 'readwrite');
						const store = tx.objectStore('CodeStore');
						await new Promise((resolve, reject) => {
							const req = store.put({ name, code });
							req.onsuccess = resolve;
							req.onerror = reject;
						});
						return true;
					} catch (e) { return false; }
				}

				function showMessage(title, content) {
					document.getElementById('messageTitle').textContent = title;
					document.getElementById('messageContent').textContent = content;
					const modal = document.getElementById('messageModal');
					modal.style.display = 'flex';
					document.getElementById('messageClose').onclick = () => modal.style.display = 'none';
				}

				function showConfirm(message) {
					return new Promise(resolve => {
						document.getElementById('confirmMessage').textContent = message;
						const modal = document.getElementById('confirmModal');
						modal.style.display = 'flex';
						document.getElementById('confirmCancel').onclick = () => {
							modal.style.display = 'none';
							resolve(false);
						};
						document.getElementById('confirmOK').onclick = () => {
							modal.style.display = 'none';
							resolve(true);
						};
					});
				}

				function filterFiles(term) {
					const items = document.querySelectorAll('.file-item');
					const lowerTerm = term.toLowerCase().trim();
					let visibleCount = 0;

					items.forEach(el => {
						const name = el.querySelector('.file-name').textContent.toLowerCase();
						if (name.includes(lowerTerm)) {
							el.style.display = 'flex';
							visibleCount++;
						} else {
							el.style.display = 'none';
						}
					});

					document.querySelectorAll('.empty-tip.search-empty').forEach(e => e.remove());

					if (lowerTerm && visibleCount === 0) {
						const tip = document.createElement('div');
						tip.className = 'empty-tip search-empty';
						tip.textContent = '未找到匹配的文件';
						document.getElementById('fileList').appendChild(tip);
					}
				}

				const selectedCountEl = document.getElementById('selectedCount');
				const selectAllCheckbox = document.getElementById('selectAll');

				function updateSelectedCount() {
					selectedCountEl.textContent = selectedFiles.size;
				}

				function toggleSelectFile(key, checked) {
					if (checked) selectedFiles.add(key);
					else selectedFiles.delete(key);
					updateSelectedCount();
				}

				selectAllCheckbox.addEventListener('change', function() {
					document.querySelectorAll('.file-checkbox').forEach(cb => {
						cb.checked = this.checked;
						toggleSelectFile(cb.dataset.filekey, this.checked);
					});
				});

				document.getElementById('batchDownload').addEventListener('click', async () => {
					if (!selectedFiles.size) return showMessage('提示', '请至少选择一个文件');

					for (const key of selectedFiles) {
						const file = window.fileDataMap[key];
						if (!file) continue;
						try {
							const res = await fetch(file.url);
							const blob = await res.blob();
							const a = document.createElement('a');
							a.href = URL.createObjectURL(blob);
							a.download = file.filename;
							document.body.appendChild(a);
							a.click();
							setTimeout(() => {
								document.body.removeChild(a);
								URL.revokeObjectURL(a.href);
							}, 100);
						} catch (e) { console.error('下载失败:', e); }
					}
					showMessage('成功', `✅ 开始下载 ${selectedFiles.size} 个文件`);
				});

				document.getElementById('batchImport').addEventListener('click', async () => {
					if (!selectedFiles.size) return showMessage('提示', '请至少选择一个文件');

					const localNames = await getAllCodeNamesFromDB();
					let imported = 0;

					for (const key of selectedFiles) {
						const file = window.fileDataMap[key];
						if (!file) continue;

						const cleanName = file.filename.replace(/\.js$/, '');
						let shouldImport = true;

						if (localNames.includes(cleanName)) {
							const ok = await showConfirm(`文件 "${cleanName}.js" 已存在，是否覆盖？`);
							if (!ok) shouldImport = false;
						}

						if (shouldImport) {
							try {
								const res = await fetch(file.url);
								const code = await res.text();
								const success = await saveCodeToDB(cleanName, code);
								if (success) imported++;
							} catch (e) { console.error('导入失败:', e); }
						}
					}

					showMessage('完成', `✅ 成功导入 ${imported} 个文件`);
					clearSelection();
				});

				function clearSelection() {
					selectedFiles.clear();
					updateSelectedCount();
					document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = false);
					selectAllCheckbox.checked = false;
				}

				const fileListContainer = document.getElementById('fileList');
				const loadingDiv = document.getElementById('loading');
				const searchInput = document.getElementById('searchInput');

				searchInput.addEventListener('input', () => filterFiles(searchInput.value));
				searchInput.addEventListener('keydown', e => {
					if (e.key === 'Escape') {
						searchInput.value = '';
						filterFiles('');
					}
				});

				// ======== 加载远程文件列表（使用传入的 shareUrl）========
				initDB().then(async () => {
					try {
						const res = await fetch(shareUrl); // ←←← 关键：使用传入的 URL
						const files = await res.json();

						loadingDiv.remove();

						if (!files.length) {
							fileListContainer.innerHTML = '<div class="empty-tip">暂无 JS 文件</div>';
							return;
						}

						files.forEach(file => {
							const key = file.filename;
							window.fileDataMap[key] = file;

							const item = document.createElement('div');
							item.className = 'file-item';

							const cb = document.createElement('input');
							cb.type = 'checkbox';
							cb.className = 'file-checkbox';
							cb.dataset.filekey = key;
							cb.addEventListener('change', function() {
								toggleSelectFile(key, this.checked);
								if (!this.checked) selectAllCheckbox.checked = false;
							});

							const info = document.createElement('div');
							info.className = 'file-info';
							const nameSpan = document.createElement('span');
							nameSpan.className = 'file-name';
							nameSpan.textContent = file.filename;
							info.appendChild(nameSpan);

							const actions = document.createElement('div');
							actions.className = 'file-actions';

							const downBtn = document.createElement('button');
							downBtn.className = 'btn';
							downBtn.textContent = '下载';
							downBtn.onclick = async () => {
								try {
									const res = await fetch(file.url);
									const blob = await res.blob();
									const a = document.createElement('a');
									a.href = URL.createObjectURL(blob);
									a.download = file.filename;
									document.body.appendChild(a);
									a.click();
									setTimeout(() => {
										document.body.removeChild(a);
										URL.revokeObjectURL(a.href);
									}, 100);
								} catch (e) {
									showMessage('错误', '下载失败');
								}
							};

							const importBtn = document.createElement('button');
							importBtn.className = 'btn';
							importBtn.textContent = '导入';
							importBtn.onclick = async () => {
								try {
									const res = await fetch(file.url);
									const code = await res.text();
									const cleanName = file.filename.replace(/\.js$/, '');

									const names = await getAllCodeNamesFromDB();
									if (names.includes(cleanName)) {
										const ok = await showConfirm(`文件 “${cleanName}.js” 已存在，是否覆盖？`);
										if (!ok) return;
									}

									const success = await saveCodeToDB(cleanName, code);
									if (success) showMessage('成功', `✅ 导入成功：${cleanName}`);
								} catch (e) {
									showMessage('错误', '导入失败');
								}
							};

							actions.append(downBtn, importBtn);
							item.append(cb, info, actions);
							fileListContainer.appendChild(item);
						});

					} catch (e) {
						loadingDiv.textContent = '❌ 加载失败: ' + (e.message || '网络错误');
					}
				}).catch(e => {
					document.getElementById('loading').textContent = '❌ 数据库错误: ' + e;
				});
			}

			// ========== 节点列表页逻辑 ==========
			async function loadNodes() {
				const nodesList = document.getElementById('nodesList');
				try {
					const res = await fetch('https://www.ananwind.cn/registry.php');
					if (!res.ok) throw new Error('Failed to load nodes');
					const nodes = await res.json();
					nodesList.innerHTML = '';
					if (nodes.length === 0) {
						nodesList.innerHTML = '<div class="empty">暂无注册节点</div>';
						return;
					}

					nodes.forEach((nodeUrl, index) => {
						const div = document.createElement('div');
						div.className = 'node-item';
						// 显示为"节点X"格式，并通过API获取文件数量
						div.innerHTML = `节点${index + 1} (<span id="count-${index}">加载中...</span>)`;
						div.onclick = () => initFileListView(nodeUrl); // ← 点击进入文件视图

						nodesList.appendChild(div);

						// 异步获取文件数量
						fetch(nodeUrl)
							.then(response => response.json())
							.then(files => {
								document.getElementById(`count-${index}`).textContent = `${files.length}个文件`;
							})
							.catch(error => {
								document.getElementById(`count-${index}`).textContent = '获取失败';
							});
					});
				} catch (e) {
					nodesList.innerHTML = `<div class="empty">加载失败: ${e.message}</div>`;
				}
			}

			// 修改：注册节点函数，现在会向所有节点广播注册
			document.getElementById('registerBtn').addEventListener('click', async () => {
				let domain = document.getElementById('domainInput').value.trim();
				if (!domain) return alert('请输入域名');

				// 构建新节点的URL
				let registryUrl = domain.startsWith('http') ?
					`${domain.replace(/\/+$/, '')}/registry.php` :
					`https://${domain.replace(/^\/+|\/+$/g, '')}/registry.php`;
				const shareUrl = registryUrl.replace('/registry.php', '/share.php');

				// 验证新节点的share.php是否有效
				try {
					const shareRes = await fetch(shareUrl);
					if (!shareRes.ok) {
						throw new Error('Share API不可访问');
					}
					const shareData = await shareRes.json(); // 尝试解析JSON
					if (!Array.isArray(shareData)) {
						throw new Error('Share API返回格式错误：不是数组');
					}
				} catch (e) {
					eda.sys_Message.showToastMessage('节点验证失败' + e, 'error', 2);
					return;
				}

				// 获取当前所有节点列表
				try {
					const res = await fetch('https://www.ananwind.cn/registry.php');
					if (!res.ok) throw new Error('Failed to load nodes');
					const currentNodes = await res.json();

					// 向所有现有节点广播注册新节点
					const results = await Promise.allSettled(
						currentNodes.map(nodeUrl => {
							const nodeRegistryUrl = nodeUrl.replace('/share.php', '/registry.php');
							return fetch(nodeRegistryUrl, {
								method: 'POST',
								headers: { 'Content-Type': 'text/plain' },
								body: shareUrl
							});
						})
					);

					// 检查注册结果
					const successfulRegs = results.filter(r => r.status === 'fulfilled' && r.value.ok).length;
					if (successfulRegs > 0) {
						eda.sys_Message.showToastMessage('注册成功！已向 ' + successfulRegs + '个节点广播注册新节点', 'success', 2);
						document.getElementById('domainInput').value = '';
						loadNodes(); // 刷新节点列表
					} else {
						eda.sys_Message.showToastMessage('所有节点注册均失败', 'error', 2);
					}
				} catch (e) {
					eda.sys_Message.showToastMessage('获取节点列表失败', 'error', 2);
				}
			});

			// 处理"如何成为节点?"链接点击事件
			async function handleHowToNode() {
				await eda.sys_IFrame.openIFrame("/iframe/debug/P2P/README_Light.html", 500, 500, "README");
			}
			// 初始化
			loadNodes();
		</script>
	</body>
</html>